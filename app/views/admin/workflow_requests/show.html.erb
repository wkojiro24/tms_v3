<% content_for :title, @workflow_request.title %>
<% content_for :section_label, "承認管理" %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="h5 mb-1"><%= @workflow_request.title %></h2>
    <div class="text-muted small">
      カテゴリ: <%= @workflow_request.workflow_category.name %> / 申請者: <%= @workflow_request.requester.display_name %>
    </div>
  </div>
  <%= workflow_status_badge(@workflow_request) %>
</div>

<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card card-lift h-100">
      <div class="card-header bg-white fw-semibold">申請内容</div>
      <div class="card-body">
        <dl class="row small mb-0">
          <dt class="col-4 col-md-3">申請者</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.requester.display_name %></dd>
          <% if (employee = @workflow_request.requester_employee).present? %>
            <dt class="col-4 col-md-3">社員コード</dt>
            <dd class="col-8 col-md-9"><%= employee.employee_code %> <%= employee.full_name.presence || [employee.last_name, employee.first_name].compact.join(" ") %></dd>
          <% end %>
          <dt class="col-4 col-md-3">申請日</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.submitted_at ? l(@workflow_request.submitted_at) : '-' %></dd>
          <dt class="col-4 col-md-3">必要日</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.needed_on ? l(@workflow_request.needed_on) : '-' %></dd>
          <dt class="col-4 col-md-3">金額</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.amount ? number_to_currency(@workflow_request.amount, unit: @workflow_request.currency) : '-' %></dd>
          <dt class="col-4 col-md-3">取引先</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.vendor_name.presence || '-' %></dd>
          <dt class="col-4 col-md-3">対象資産</dt>
          <dd class="col-8 col-md-9"><%= @workflow_request.vehicle_identifier.presence || '-' %></dd>
        </dl>
        <hr>
        <h6 class="fw-semibold">概要</h6>
        <p><%= simple_format(@workflow_request.summary.presence || '(概要未入力)') %></p>
        <% if @workflow_request.additional_information.present? %>
          <h6 class="fw-semibold">詳細情報</h6>
          <p><%= simple_format(@workflow_request.additional_information) %></p>
        <% end %>
        <% if @workflow_request.metadata_entries.any? %>
          <hr>
          <h6 class="fw-semibold">申請テンプレート項目</h6>
          <dl class="row small mb-0">
            <% @workflow_request.metadata_entries.each do |entry| %>
              <dt class="col-sm-4"><%= entry[:label] %></dt>
              <dd class="col-sm-8"><%= simple_format(entry[:value].to_s) %></dd>
            <% end %>
          </dl>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card card-lift h-100">
      <div class="card-header bg-white fw-semibold">添付資料</div>
      <div class="card-body">
        <% if @workflow_request.documents.attached? %>
          <div class="list-group list-group-flush">
            <% @workflow_request.documents.each do |document| %>
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold"><%= document.filename.to_s %></div>
                    <div class="text-muted small"><%= number_to_human_size(document.byte_size) %></div>
                  </div>
                  <%= link_to rails_blob_path(document, disposition: 'attachment'), class: 'btn btn-sm btn-outline-secondary' do %>
                    <i class="bi bi-download"></i>
                  <% end %>
                </div>
                <% if previewable_blob?(document) %>
                  <div class="mt-2 ratio ratio-4x3">
                    <% if document.image? %>
                      <%= image_tag url_for(document), class: 'img-fluid rounded', alt: document.filename.to_s %>
                    <% else %>
                      <iframe src="<%= rails_blob_path(document, disposition: 'inline') %>" class="border rounded"></iframe>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-muted">添付はありません。</div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="card card-lift mb-4">
  <div class="card-header bg-white fw-semibold">コメント</div>
  <div class="card-body">
    <% if @notes.any? %>
      <div class="list-group list-group-flush mb-4">
        <% @notes.each do |note| %>
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold"><%= note.author_display_name %></div>
                <div class="small text-muted"><%= l(note.created_at, format: :short) %></div>
              </div>
            </div>
            <p class="mb-0 mt-2"><%= simple_format(note.body) %></p>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-muted">コメントはまだありません。</div>
    <% end %>

    <%= form_with url: comment_admin_workflow_request_path(@workflow_request), method: :post, local: true do %>
      <div class="mb-3">
        <label class="form-label">コメントを追加</label>
        <textarea name="comment" rows="3" class="form-control" placeholder="共有したい補足や判断理由を記入してください" required></textarea>
      </div>
      <div class="text-end">
        <button type="submit" class="btn btn-outline-primary btn-sm">コメント追加</button>
      </div>
    <% end %>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-white fw-semibold">承認ステータス</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>順番</th>
            <th>ステップ</th>
            <th>担当</th>
            <th>状態</th>
            <th>最終コメント</th>
            <th>処理日時</th>
          </tr>
        </thead>
        <tbody>
          <% @stages.each do |stage| %>
            <tr class="<%= 'table-warning' if stage.status == 'active' %>">
              <td><%= stage.position %></td>
              <td><%= stage.name %></td>
              <td><%= stage.responsible_label %></td>
              <td><span class="badge bg-secondary"><%= stage.status.humanize %></span></td>
              <td><%= stage.last_comment.presence || '-' %></td>
              <td><%= stage.completed_at ? l(stage.completed_at) : '-' %></td>
            </tr>
            <% stage.approvals.each do |approval| %>
              <tr class="small text-muted">
                <td></td>
                <td colspan="2">
                  <i class="bi bi-arrow-return-right"></i>
                  <%= approval.actor.display_name %> が <%= approval.action %>
                </td>
                <td colspan="3">
                  <span class="me-2"><%= l(approval.acted_at) %></span>
                  <%= approval.comment.presence || 'コメントなし' %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<% if @can_act %>
  <div class="card card-lift mb-4">
    <div class="card-header bg-white fw-semibold">承認アクション</div>
    <div class="card-body">
      <%= form_with url: decide_admin_workflow_request_path(@workflow_request), method: :post, class: 'row g-3', local: true do |f| %>
        <div class="col-12">
          <label class="form-label">コメント</label>
          <textarea name="comment" rows="3" class="form-control" placeholder="承認・差戻しの理由を入力してください"></textarea>
        </div>
        <div class="col-12 d-flex flex-wrap gap-2">
          <button type="submit" name="decision" value="approved" class="btn btn-success">承認</button>
          <button type="submit" name="decision" value="held" class="btn btn-warning">保留</button>
          <button type="submit" name="decision" value="returned" class="btn btn-outline-secondary">差戻し</button>
          <button type="submit" name="decision" value="rejected" class="btn btn-danger" data-turbo-confirm="本当に却下しますか？">却下</button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<div class="d-flex justify-content-between">
  <%= link_to "一覧に戻る", admin_workflow_requests_path, class: "btn btn-outline-secondary" %>
  <%= link_to "申請ページを表示", workflow_request_path(@workflow_request), class: "btn btn-sm btn-light" %>
</div>
